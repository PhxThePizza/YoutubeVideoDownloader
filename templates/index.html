<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Video Downloader</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        input[type="text"]:focus {
            border-color: #007bff;
            outline: none;
        }
        input[type="text"].invalid {
            border-color: #dc3545;
        }
        .validation-message {
            font-size: 14px;
            margin-top: 5px;
            color: #dc3545;
        }
        .btn {
            background-color: #007bff;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .download-link {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            background-color: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }
        .download-link:hover {
            background-color: #218838;
        }
        .info {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }
        .downloads-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }
        .download-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .file-info {
            flex-grow: 1;
        }
        .file-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        .delete-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¥ YouTube Video Downloader</h1>
        
        <div class="info">
            <strong>How to use:</strong> Enter a YouTube video ID (like "dQw4w9WgXcQ") or paste a full YouTube URL.
            The video will be downloaded and made available for you to download.
        </div>

        <form id="downloadForm" action="/download" method="POST">
            <div class="form-group">
                <label for="video_id">YouTube Video ID or URL:</label>
                <input type="text" id="video_id" name="video_id" 
                       placeholder="Enter video ID (e.g., dQw4w9WgXcQ) or full YouTube URL"
                       required>
                <div id="validation-message" class="validation-message"></div>
            </div>
            <button type="submit" class="btn" id="downloadBtn">Download Video</button>
        </form>

        <div id="message"></div>
        
        <div class="downloads-section">
            <h3>Downloaded Videos</h3>
            <div id="downloadsList">
                <p>Loading...</p>
            </div>
            <button type="button" class="btn" onclick="loadDownloads()" style="margin-top: 10px;">Refresh List</button>
        </div>
    </div>

    <script>
        // Input validation functions
        function validateYouTubeInput(input) {
            const trimmed = input.trim();
            
            if (!trimmed) {
                return { valid: false, message: 'Please enter a YouTube video ID or URL' };
            }
            
            if (trimmed.length > 2048) {
                return { valid: false, message: 'URL too long' };
            }
            
            // Check for invalid characters
            if (/[<>"']/.test(trimmed)) {
                return { valid: false, message: 'Invalid characters in URL' };
            }
            
            // Basic YouTube URL patterns
            const youtubePatterns = [
                /^[a-zA-Z0-9_-]{11}$/,  // Video ID
                /youtube\.com.*[?&]v=([a-zA-Z0-9_-]{11})/,  // youtube.com watch URL
                /youtu\.be\/([a-zA-Z0-9_-]{11})/,  // youtu.be short URL
                /youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/,  // embed URL
                /youtube\.com\/shorts\/([a-zA-Z0-9_-]{11})/  // shorts URL
            ];
            
            const isValidYouTube = youtubePatterns.some(pattern => pattern.test(trimmed));
            
            if (!isValidYouTube && !trimmed.includes('youtube.com') && !trimmed.includes('youtu.be')) {
                return { valid: false, message: 'Please enter a valid YouTube URL or video ID' };
            }
            
            return { valid: true, message: '' };
        }
        
        function showValidationMessage(message, isError = false) {
            const validationDiv = document.getElementById('validation-message');
            const input = document.getElementById('video_id');
            
            if (message) {
                validationDiv.textContent = message;
                validationDiv.style.display = 'block';
                if (isError) {
                    input.classList.add('invalid');
                } else {
                    input.classList.remove('invalid');
                }
            } else {
                validationDiv.style.display = 'none';
                input.classList.remove('invalid');
            }
        }
        
        // Real-time validation
        document.getElementById('video_id').addEventListener('input', function() {
            const validation = validateYouTubeInput(this.value);
            const submitBtn = document.getElementById('downloadBtn');
            
            if (this.value.trim() === '') {
                showValidationMessage('');
                submitBtn.disabled = false;
            } else if (!validation.valid) {
                showValidationMessage(validation.message, true);
                submitBtn.disabled = true;
            } else {
                showValidationMessage('');
                submitBtn.disabled = false;
            }
        });
        
        document.getElementById('downloadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const form = e.target;
            const input = document.getElementById('video_id');
            const validation = validateYouTubeInput(input.value);
            
            // Final validation check
            if (!validation.valid) {
                showValidationMessage(validation.message, true);
                return;
            }
            
            const formData = new FormData(form);
            const messageDiv = document.getElementById('message');
            const submitBtn = document.getElementById('downloadBtn');
            
            // Clear any validation messages
            showValidationMessage('');
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Downloading...';
            messageDiv.innerHTML = '<div class="message">Downloading video, please wait...</div>';
            
            fetch('/download', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    messageDiv.innerHTML = `
                        <div class="message success">
                            ${data.message}
                            <br>
                            <a href="${data.download_url}" class="download-link">Download ${data.filename}</a>
                        </div>
                    `;
                    // Clear the form
                    form.reset();
                    // Refresh the downloads list
                    loadDownloads();
                } else {
                    messageDiv.innerHTML = `<div class="message error">${data.message || 'Unknown error occurred'}</div>`;
                }
            })
            .catch(error => {
                let errorMessage = 'Network error. Please check your connection and try again.';
                if (error.message) {
                    errorMessage = `Error: ${error.message}`;
                }
                messageDiv.innerHTML = `<div class="message error">${errorMessage}</div>`;
            })
            .finally(() => {
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.textContent = 'Download Video';
            });
        });

        function loadDownloads() {
            const downloadsList = document.getElementById('downloadsList');
            downloadsList.innerHTML = '<p>Loading...</p>';
            
            fetch('/list_downloads')
            .then(response => response.json())
            .then(files => {
                if (files.length === 0) {
                    downloadsList.innerHTML = '<p>No downloads yet.</p>';
                } else {
                    // Clear the container
                    downloadsList.innerHTML = '';
                    
                    // Create download items securely using DOM manipulation
                    files.forEach(file => {
                        // Create main container
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'download-item';
                        
                        // Create file info section
                        const fileInfoDiv = document.createElement('div');
                        fileInfoDiv.className = 'file-info';
                        const fileInfoSpan = document.createElement('span');
                        // Use textContent to prevent XSS
                        fileInfoSpan.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                        fileInfoDiv.appendChild(fileInfoSpan);
                        
                        // Create actions section
                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'file-actions';
                        
                        // Create download link
                        const downloadLink = document.createElement('a');
                        downloadLink.href = file.url;
                        downloadLink.className = 'download-link';
                        downloadLink.textContent = 'Download';
                        
                        // Create delete button with data attribute (no onclick)
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-btn';
                        deleteBtn.textContent = 'Delete';
                        deleteBtn.setAttribute('data-filename', file.name);
                        
                        // Add secure event listener
                        deleteBtn.addEventListener('click', function(e) {
                            deleteFile(file.name, e.target);
                        });
                        
                        // Assemble the structure
                        actionsDiv.appendChild(downloadLink);
                        actionsDiv.appendChild(deleteBtn);
                        itemDiv.appendChild(fileInfoDiv);
                        itemDiv.appendChild(actionsDiv);
                        downloadsList.appendChild(itemDiv);
                    });
                }
            })
            .catch(error => {
                downloadsList.innerHTML = '<p>Error loading downloads.</p>';
            });
        }

        function deleteFile(filename, deleteBtn) {
            // Use textContent for safe display of filename in confirmation
            const confirmDiv = document.createElement('div');
            confirmDiv.textContent = `Are you sure you want to delete "${filename}"?`;
            
            if (confirm(confirmDiv.textContent)) {
                const originalText = deleteBtn.textContent;
                
                // Show loading state
                deleteBtn.disabled = true;
                deleteBtn.textContent = 'Deleting...';
                
                fetch(`/delete_file/${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    // Handle different HTTP status codes properly
                    if (response.status === 204) {
                        // Successful deletion (204 No Content)
                        showInPageMessage(`File "${filename}" deleted successfully`, 'success');
                        loadDownloads();
                        return;
                    } else if (response.status === 404) {
                        throw new Error('File not found');
                    } else if (response.status === 400) {
                        return response.json().then(data => {
                            throw new Error(data.message || 'Invalid request');
                        });
                    } else if (response.status === 403) {
                        throw new Error('Permission denied');
                    } else if (response.status >= 500) {
                        throw new Error('Server error');
                    } else {
                        // For responses with JSON body
                        return response.json();
                    }
                })
                .then(data => {
                    if (data && data.success) {
                        showInPageMessage(data.message, 'success');
                        loadDownloads();
                    } else if (data && !data.success) {
                        showInPageMessage(`Error: ${data.message}`, 'error');
                        // Reset button state
                        deleteBtn.disabled = false;
                        deleteBtn.textContent = originalText;
                    }
                })
                .catch(error => {
                    showInPageMessage(`Error deleting file: ${error.message}`, 'error');
                    // Reset button state
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = originalText;
                });
            }
        }

        // Helper function for secure in-page messaging
        function showInPageMessage(message, type) {
            const messageDiv = document.getElementById('message');
            const msgElement = document.createElement('div');
            msgElement.className = `message ${type}`;
            msgElement.textContent = message;
            
            // Clear any existing messages and add new one
            messageDiv.innerHTML = '';
            messageDiv.appendChild(msgElement);
            
            // Clear success messages after 3 seconds
            if (type === 'success') {
                setTimeout(() => {
                    if (messageDiv.contains(msgElement)) {
                        messageDiv.removeChild(msgElement);
                    }
                }, 3000);
            }
        }
        
        // Load downloads on page load
        loadDownloads();
    </script>
</body>
</html>